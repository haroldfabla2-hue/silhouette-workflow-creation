# Ingress principal para la aplicación
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: silhouette-main
  namespace: silhouette-production
  labels:
    app: silhouette
    version: "5.0.0"
  annotations:
    # AWS Load Balancer Controller
    kubernetes.io/ingress.class: "alb"
    alb.ingress.kubernetes.io/scheme: "internet-facing"
    alb.ingress.kubernetes.io/target-type: "instance"
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    alb.ingress.kubernetes.io/ssl-redirect: "true"
    alb.ingress.kubernetes.io/backend-protocol: "HTTP"
    
    # Certificados SSL
    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012"
    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": {"Protocol": "HTTPS", "Port": "443", "StatusCode": "301"}}'
    
    # Configuración de health checks
    alb.ingress.kubernetes.io/healthcheck-path: "/_next/health"
    alb.ingress.kubernetes.io/healthcheck-port: "3000"
    alb.ingress.kubernetes.io/healthcheck-protocol: "HTTP"
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthcheck-healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/healthcheck-unhealthy-threshold-count: "3"
    
    # WAF y Security
    alb.ingress.kubernetes.io/wafv2-acl-arn: "arn:aws:wafv2:us-east-1:123456789012:global/webacl/silhouette-waf"
    alb.ingress.kubernetes.io/cognito-auth-domain: "auth.silhouette.com"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/rate-limit-burst: "2000"
    
    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://app.silhouette.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET,POST,PUT,DELETE,OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    nginx.ingress.kubernetes.io/cors-expose-headers: "Content-Length,Content-Range"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Referrer-Policy "no-referrer-when-downgrade" always;
      add_header Content-Security-Policy "default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval';" always;
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Compresión
    nginx.ingress.kubernetes.io/enable-gzip: "true"
    nginx.ingress.kubernetes.io/gzip-level: "6"
    nginx.ingress.kubernetes.io/gzip-types: "text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "5"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    
    # Session affinity
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-cookie-name: "silhouette_session"
    nginx.ingress.kubernetes.io/affinity-cookie-expires: "86400"
    nginx.ingress.kubernetes.io/affinity-cookie-max-age: "86400"
spec:
  tls:
  - hosts:
    - app.silhouette.com
    - api.silhouette.com
    - admin.silhouette.com
    - auth.silhouette.com
    secretName: silhouette-tls-secret
  rules:
  - host: app.silhouette.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: silhouette-frontend
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: silhouette-backend
            port:
              number: 80
      - path: /_next
        pathType: Prefix
        backend:
          service:
            name: silhouette-frontend
            port:
              number: 80
      - path: /static
        pathType: Prefix
        backend:
          service:
            name: silhouette-frontend
            port:
              number: 80
  - host: api.silhouette.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: silhouette-backend
            port:
              number: 80
  - host: admin.silhouette.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: silhouette-frontend
            port:
              number: 80
  - host: auth.silhouette.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: silhouette-frontend
            port:
              number: 80
---
# Ingress para métricas (solo interno)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: silhouette-metrics
  namespace: silhouette-production
  labels:
    app: silhouette
    component: metrics
  annotations:
    kubernetes.io/ingress.class: "nginx-internal"
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    nginx.ingress.kubernetes.io/auth-type: "basic"
    nginx.ingress.kubernetes.io/auth-secret: "nginx-auth"
    nginx.ingress.kubernetes.io/auth-realm: "Silhouette Metrics - Authentication Required"
    nginx.ingress.kubernetes.io/enable-cors: "false"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  tls:
  - hosts:
    - metrics.silhouette.internal
    secretName: silhouette-metrics-tls-secret
  rules:
  - host: metrics.silhouette.internal
    http:
      paths:
      - path: /backend
        pathType: Prefix
        backend:
          service:
            name: silhouette-backend-metrics
            port:
              number: 9090
      - path: /frontend
        pathType: Prefix
        backend:
          service:
            name: silhouette-frontend-metrics
            port:
              number: 9091
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-server
            port:
              number: 80
---
# Ingress para gestión de bases de datos (solo administración)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: silhouette-db-management
  namespace: silhouette-production
  labels:
    app: silhouette
    component: db-management
  annotations:
    kubernetes.io/ingress.class: "nginx-internal"
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    nginx.ingress.kubernetes.io/auth-type: "basic"
    nginx.ingress.kubernetes.io/auth-secret: "db-admin-auth"
    nginx.ingress.kubernetes.io/auth-realm: "Database Management - Admin Access Only"
    nginx.ingress.kubernetes.io/enable-ssl: "false"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  rules:
  - host: postgres-admin.silhouette.internal
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: postgres-admin
            port:
              number: 80
  - host: rabbitmq-admin.silhouette.internal
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rabbitmq-admin
            port:
              number: 80
  - host: neo4j-admin.silhouette.internal
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: neo4j-admin
            port:
              number: 80
---
# Certificados TLS
apiVersion: v1
kind: Secret
metadata:
  name: silhouette-tls-secret
  namespace: silhouette-production
  labels:
    app: silhouette
    type: tls
type: kubernetes.io/tls
data:
  # En producción, usar certificados reales del Certificate Manager
  tls.crt: "LS0tLS1CRUdJTi=="
  tls.key: "LS0tLS1CRUdJTi=="
---
apiVersion: v1
kind: Secret
metadata:
  name: silhouette-metrics-tls-secret
  namespace: silhouette-production
  labels:
    app: silhouette
    type: tls
    component: metrics
type: kubernetes.io/tls
data:
  tls.crt: "LS0tLS1CRUdJTi=="
  tls.key: "LS0tLS1CRUdJTi=="