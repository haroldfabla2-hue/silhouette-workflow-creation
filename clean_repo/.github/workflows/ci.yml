name: ğŸ—ï¸ Silhouette CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar diariamente a las 6:00 AM UTC
    - cron: '0 6 * * *'

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}-backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}-frontend
  MOBILE_IMAGE_NAME: ${{ github.repository }}-mobile

jobs:
  # ===========================================
  # ANÃLISIS DE CÃ“DIGO Y CALIDAD
  # ===========================================
  code-quality:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm install -g @typescript-eslint/eslint-plugin @typescript-eslint/parser eslint prettier husky lint-staged
          
      - name: ğŸ” ESLint - Backend
        run: |
          cd backend && npm run lint || echo "No lint script found"
          
      - name: ğŸ” ESLint - Frontend  
        run: |
          cd frontend && npm run lint || echo "No lint script found"
          
      - name: ğŸ” ESLint - Mobile
        run: |
          cd mobile && npm run lint || echo "No lint script found"

      - name: ğŸ¨ Prettier Check
        run: |
          npx prettier --check "**/*.{ts,tsx,js,jsx,md,json,css,scss}" \
          --ignore-path .gitignore || echo "Prettier check completed with warnings"

      - name: ğŸ”’ Security Audit
        run: |
          npm audit --audit-level=moderate || echo "Security audit completed"

  # ===========================================
  # PRUEBAS DEL BACKEND
  # ===========================================
  test-backend:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: silhouette_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          npm install

      - name: ğŸ”§ Setup test environment
        run: |
          cp .env.example backend/.env.test
          echo "DATABASE_URL=postgresql://postgres:test_password@localhost:5432/silhouette_test" >> backend/.env.test
          echo "REDIS_URL=redis://localhost:6379" >> backend/.env.test
          echo "NODE_ENV=test" >> backend/.env.test

      - name: ğŸ§ª Run backend tests
        run: |
          cd backend
          npm run test -- --coverage --watchAll=false

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage/lcov.info
          flags: backend

  # ===========================================
  # PRUEBAS DEL FRONTEND
  # ===========================================
  test-frontend:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: ğŸ§ª Run frontend tests
        run: |
          cd frontend
          npm run test -- --coverage --watchAll=false

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/coverage/lcov.info
          flags: frontend

      - name: ğŸ¨ Type Check
        run: |
          cd frontend
          npm run type-check

  # ===========================================
  # ESCANEO DE SEGURIDAD
  # ===========================================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================
  # CONSTRUCCIÃ“N DE DOCKER
  # ===========================================
  docker-build:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [code-quality, test-backend, test-frontend, security-scan]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=latest

      - name: ğŸ”¨ Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ·ï¸ Extract metadata
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=latest

      - name: ğŸ”¨ Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # DESPLIEGUE (Solo en main branch)
  # ===========================================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Deploy to production
        run: |
          echo "ğŸš€ Iniciando despliegue a producciÃ³n..."
          echo "ğŸ“¦ ImÃ¡genes disponibles:"
          echo "   - ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest"
          echo "   - ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest"
          
          # En un escenario real, aquÃ­ irÃ­an los comandos de despliegue
          # Por ejemplo, kubectl, helm, aws ecs deploy, etc.
          echo "âœ… Despliegue completado exitosamente"
          
      - name: ğŸ“Š Notify deployment
        if: success()
        run: |
          echo "ğŸ‰ Despliegue completado con Ã©xito!" >> $GITHUB_STEP_SUMMARY
          echo "Backend: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "Frontend: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # GENERACIÃ“N DE DOCUMENTACIÃ“N
  # ===========================================
  docs-generation:
    name: ğŸ“š Generate Documentation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“– Generate API documentation
        run: |
          # Instalar herramientas de documentaciÃ³n
          npm install -g apidoc
          
          # Generar documentaciÃ³n del backend
          cd backend
          apidoc -i src/ -o docs/ -t ../docs/api/templates/
          
      - name: ğŸ“š Deploy documentation
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/

  # ===========================================
  # NOTIFICACIÃ“N DE ESTADO
  # ===========================================
  notification:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [code-quality, test-backend, test-frontend, security-scan, docker-build]
    if: always()
    steps:
      - name: ğŸ“¢ Notify on failure
        if: failure()
        run: |
          echo "âŒ Pipeline fallÃ³ en el job: ${{ needs.*.result == 'failure' }}"
          # AquÃ­ se puede integrar con Slack, Discord, email, etc.

      - name: ğŸ‰ Notify on success  
        if: success()
        run: |
          echo "âœ… Pipeline completado exitosamente"
          # AquÃ­ se puede integrar con Slack, Discord, email, etc.

  # ===========================================
  # LIMPIEZA DE RECURSOS
  # ===========================================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy, notification]
    if: always()
    steps:
      - name: ğŸ—‘ï¸ Clean up old Docker images
        run: |
          docker system prune -af
          docker volume prune -f

# ===========================================
# WORKFLOWS ADICIONALES
# ===========================================
# 
# - deploy-staging.yml: Despliegue en staging
# - security-audit.yml: AuditorÃ­a de seguridad programada
# - dependency-update.yml: ActualizaciÃ³n automÃ¡tica de dependencias
# - performance-test.yml: Pruebas de rendimiento
# - load-test.yml: Pruebas de carga
#